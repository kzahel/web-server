#!/bin/bash
# Postinstall script for 200 OK Desktop .pkg installer
# Registers native messaging host manifests for all Chromium browsers.

# $2 is the install location: "/" for system-domain, user home for user-domain
INSTALL_BASE="${2:-/}"
APP_PATH="$INSTALL_BASE/Applications/200 OK.app"

# Find the host sidecar binary (architecture-specific name)
HOST_BIN=$(find "$APP_PATH/Contents/MacOS" -name "ok200-host-*" -not -name "*.dwarf" 2>/dev/null | head -1)

if [ -z "$HOST_BIN" ]; then
    echo "Warning: Could not find ok200-host sidecar binary in $APP_PATH"
    exit 0
fi

# Determine the real user's home directory
# For user-domain installs, $2 is already the home dir; for system-domain, look it up
if [ "$INSTALL_BASE" != "/" ]; then
    USER_HOME="$INSTALL_BASE"
else
    CONSOLE_USER=$(stat -f "%Su" /dev/console)
    USER_HOME=$(dscl . -read /Users/"$CONSOLE_USER" NFSHomeDirectory | awk '{print $2}')
fi

if [ -z "$USER_HOME" ] || [ ! -d "$USER_HOME" ]; then
    echo "Warning: Could not determine user home directory"
    exit 0
fi

# Build native messaging manifest (matches native_host.rs)
MANIFEST=$(cat <<EOF
{
  "name": "app.ok200.native",
  "description": "200 OK Web Server Native Messaging Host",
  "path": "$HOST_BIN",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://PLACEHOLDER_STABLE_ID/",
    "chrome-extension://PLACEHOLDER_DEV_ID/"
  ]
}
EOF
)

# Register for all Chromium browsers (matches native_host.rs browser list)
APP_SUPPORT="$USER_HOME/Library/Application Support"
BROWSERS=(
    "Google/Chrome"
    "Google/Chrome Canary"
    "Chromium"
    "BraveSoftware/Brave-Browser"
    "Microsoft Edge"
    "Vivaldi"
    "Arc/User Data"
)

for browser in "${BROWSERS[@]}"; do
    BROWSER_DIR="$APP_SUPPORT/$browser"
    if [ -d "$BROWSER_DIR" ]; then
        HOSTS_DIR="$BROWSER_DIR/NativeMessagingHosts"
        mkdir -p "$HOSTS_DIR"
        echo "$MANIFEST" > "$HOSTS_DIR/app.ok200.native.json"
        chmod 644 "$HOSTS_DIR/app.ok200.native.json"
        echo "Registered native host for $browser"
    fi
done

# Register with LaunchServices
/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH" 2>/dev/null

exit 0
