name: Tauri App CI

on:
  push:
    branches: [main]
    tags:
      - 'desktop-v*'
    paths:
      - 'desktop/**'
      - 'packages/**'
      - '.github/workflows/tauri-app-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'desktop/**'
      - 'packages/**'
      - '.github/workflows/tauri-app-ci.yml'

permissions:
  contents: write

jobs:
  test-desktop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './desktop -> target'

      - name: Run Rust tests
        working-directory: desktop
        run: cargo test -p ok200-host -p ok200-common

  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_target: aarch64-apple-darwin
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
            rust_target: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ''
            rust_target: ''
          - platform: windows-latest
            args: ''
            rust_target: ''

    runs-on: ${{ matrix.platform }}

    env:
      HAS_MACOS_SIGNING: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 != '' }}
      HAS_MACOS_NOTARIZATION: ${{ secrets.ASC_API_KEY_P8_BASE64 != '' }}
      HAS_WINDOWS_SIGNING: ${{ secrets.AZURE_CLIENT_SECRET != '' }}

    steps:
      - uses: actions/checkout@v4

      # --- Node.js + pnpm ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # --- Rust ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './desktop -> target'

      # --- Linux system dependencies ---
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev xdg-utils

      # --- macOS code signing ---
      - name: Set up macOS code signing keychain
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_SIGNING == 'true'
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          rm -f certificate.p12

      - name: Set up macOS notarization credentials
        if: matrix.platform == 'macos-latest' && env.HAS_MACOS_NOTARIZATION == 'true'
        env:
          ASC_API_KEY_P8_BASE64: ${{ secrets.ASC_API_KEY_P8_BASE64 }}
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          KEY_PATH="$HOME/private_keys/AuthKey_${ASC_API_KEY_ID}.p8"
          echo "$ASC_API_KEY_P8_BASE64" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "APPLE_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      # --- Windows signing tool ---
      - name: Install trusted-signing-cli
        if: matrix.platform == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
        run: cargo install trusted-signing-cli

      # --- Build sidecar ---
      - name: Build sidecar
        shell: bash
        working-directory: desktop
        run: |
          if [ -n "${{ matrix.rust_target }}" ]; then
            TARGET="${{ matrix.rust_target }}"
            cargo build --release -p ok200-host --target "$TARGET"
            mkdir -p tauri-app/src-tauri/binaries
            if [[ "$TARGET" == *"windows"* ]]; then
              cp "target/$TARGET/release/ok200-host.exe" "tauri-app/src-tauri/binaries/ok200-host-$TARGET.exe"
            else
              cp "target/$TARGET/release/ok200-host" "tauri-app/src-tauri/binaries/ok200-host-$TARGET"
            fi
          else
            TRIPLE="$(rustc --print host-tuple)"
            cargo build --release -p ok200-host
            mkdir -p tauri-app/src-tauri/binaries
            if [ "${{ matrix.platform }}" = "windows-latest" ]; then
              cp "target/release/ok200-host.exe" "tauri-app/src-tauri/binaries/ok200-host-$TRIPLE.exe"
            else
              cp "target/release/ok200-host" "tauri-app/src-tauri/binaries/ok200-host-$TRIPLE"
            fi
          fi

      # --- Install frontend dependencies ---
      - name: Install frontend dependencies
        run: pnpm install

      # --- Extract changelog ---
      - name: Extract changelog
        id: changelog
        if: startsWith(github.ref, 'refs/tags/desktop-v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#desktop-v}"
          NOTES=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" desktop/tauri-app/CHANGELOG.md 2>/dev/null || true)
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # --- Build Tauri app ---
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          APPIMAGE_EXTRACT_AND_RUN: '1'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Updater signing
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # macOS code signing
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: "${{ matrix.platform == 'macos-latest' && 'Developer ID Application: Kyle Graehl (VD7BYQ6ABM)' || '' }}"
          # macOS notarization
          APPLE_API_KEY: ${{ secrets.ASC_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.ASC_API_ISSUER_ID }}
          # Windows signing
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        with:
          projectPath: desktop/tauri-app
          tauriScript: pnpm tauri
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && 'desktop-v__VERSION__' || '' }}
          releaseName: '200 OK v__VERSION__'
          releaseBody: ${{ steps.changelog.outputs.notes || 'See the assets to download and install this version.' }}
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: ${{ startsWith(github.ref, 'refs/tags/') }}
          updaterJsonKeepUniversal: true
          args: >-
            ${{ matrix.args }}
            ${{ matrix.platform == 'windows-latest' && secrets.AZURE_CLIENT_SECRET != '' && '--config ''{"bundle":{"windows":{"signCommand":"trusted-signing-cli -e https://eus.codesigning.azure.net -a kylegraehl -c ok200-profile %1"}}}''' || '' }}

      # --- Build macOS .pkg installer ---
      - name: Build macOS .pkg installer
        if: matrix.platform == 'macos-latest' && startsWith(github.ref, 'refs/tags/desktop-v')
        shell: bash
        env:
          INSTALLER_IDENTITY: "${{ env.HAS_MACOS_SIGNING == 'true' && 'Developer ID Installer: Kyle Graehl (VD7BYQ6ABM)' || '' }}"
        run: |
          VERSION="${GITHUB_REF_NAME#desktop-v}"
          TARGET="${{ matrix.rust_target }}"
          if [ "$TARGET" = "aarch64-apple-darwin" ]; then
            ARCH="aarch64"
          else
            ARCH="x64"
          fi
          # Find the .app bundle from Tauri build output
          APP_PATH=$(find desktop/tauri-app/src-tauri/target/"$TARGET"/release/bundle/macos -name "200 OK.app" -maxdepth 1 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "Warning: Could not find 200 OK.app, skipping .pkg build"
            exit 0
          fi
          bash desktop/tauri-app/scripts/build-macos-pkg.sh "$APP_PATH" "$VERSION" "$ARCH"
          echo "PKG_FILE=200_OK_${VERSION}_${ARCH}.pkg" >> "$GITHUB_ENV"

      - name: Upload .pkg to release
        if: matrix.platform == 'macos-latest' && startsWith(github.ref, 'refs/tags/desktop-v') && env.PKG_FILE != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release upload "$TAG" "$PKG_FILE" --clobber

      # --- Notarize .pkg ---
      - name: Notarize .pkg
        if: matrix.platform == 'macos-latest' && startsWith(github.ref, 'refs/tags/desktop-v') && env.HAS_MACOS_NOTARIZATION == 'true' && env.PKG_FILE != ''
        env:
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          xcrun notarytool submit "$PKG_FILE" \
            --key "$APPLE_API_KEY_PATH" \
            --key-id "$ASC_API_KEY_ID" \
            --issuer "$ASC_API_ISSUER_ID" \
            --wait
          xcrun stapler staple "$PKG_FILE"
          # Re-upload stapled .pkg
          TAG="${GITHUB_REF_NAME}"
          gh release upload "$TAG" "$PKG_FILE" --clobber

      # --- Diagnose flaky DMG bundling ---
      - name: Check for flaky DMG bundling failure
        if: failure() && matrix.platform == 'macos-latest'
        run: |
          echo ""
          echo "::error::macOS DMG bundling failed. This is likely the known flaky hdiutil issue on GitHub Actions runners. Re-run this job: gh run rerun ${{ github.run_id }} --failed"

      # --- Cleanup ---
      - name: Clean up macOS keychain
        if: matrix.platform == 'macos-latest' && always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/private_keys 2>/dev/null || true

  # Clean up release assets after all builds complete
  finalize-release:
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Remove .sig files from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release view "$TAG" --json assets --jq '.assets[].name' | grep '\.sig$' | while read -r name; do
            echo "Deleting $name"
            gh release delete-asset "$TAG" "$name" --yes
          done

      - name: Update release body with download table
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#desktop-v}"
          REPO="${GITHUB_REPOSITORY}"
          BASE="https://github.com/${REPO}/releases/download/${TAG}"

          CHANGELOG=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{found=0} found" desktop/tauri-app/CHANGELOG.md 2>/dev/null || true)

          {
            if [ -n "$CHANGELOG" ]; then
              echo "$CHANGELOG"
              echo ""
            fi
            echo "## Download"
            echo ""
            echo "| Platform | |"
            echo "|----------|-|"
            echo "| macOS (Apple Silicon) | [.dmg](${BASE}/200+OK_${VERSION}_aarch64.dmg) · [.pkg](${BASE}/200_OK_${VERSION}_aarch64.pkg) |"
            echo "| macOS (Intel) | [.dmg](${BASE}/200+OK_${VERSION}_x64.dmg) · [.pkg](${BASE}/200_OK_${VERSION}_x64.pkg) |"
            echo "| Windows | [.exe](${BASE}/200+OK_${VERSION}_x64-setup.exe) · [.msi](${BASE}/200+OK_${VERSION}_x64_en-US.msi) |"
            echo "| Linux | [.deb](${BASE}/200-ok_${VERSION}_amd64.deb) · [.AppImage](${BASE}/200-ok_${VERSION}_amd64.AppImage) · [.rpm](${BASE}/200-ok-${VERSION}-1.x86_64.rpm) |"
          } > /tmp/release-body.md

          gh release edit "$TAG" --notes-file /tmp/release-body.md
